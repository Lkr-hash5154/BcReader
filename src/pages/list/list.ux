
<template>
  <div class="page">
    <list class="list">
      <list-item for="{{visibleChapters}}" class="item" @click="selectChapter($item)" type="chapter">
        <div class="chapter-info">
            <text class="itemtext {{currentChapterIndex == $item.index ? 'itemtext-current' : ''}}">{{$item.name}}</text>
            <text class="itemtext2">{{$item.wordCount}} 字</text>
        </div>
      </list-item>
      <list-item type="pagination" class="pagination-container" if="{{totalPages > 1}}">
        <div class="pagination-controls">
          <img src="/common/images/pre.png" if="{{currentPage > 0}}" @click="prevPage" class="pagination-button"/>
          <text class="pagination-text">{{currentPage + 1}} / {{totalPages}}</text>
          <img src="/common/images/next.png" if="{{currentPage < totalPages - 1}}" @click="nextPage" class="pagination-button"/>
        </div>
      </list-item>
    </list>

    <img static src="/common/images/hd.png" style="position: absolute;left: 0px;top: 0px;width: 432px;height: 102px;" />
    <img static src="/common/images/back.png" @click="back" style="position: absolute;left: 38px;top: 24px;width: 82px;height: 82px;"/>
    <text style="position: absolute;left: 130px;top: 16px;width: 172px;line-height: 32px;font-weight:bold;font-size:24px;color:rgba(255,255,255,0.6);text-align:center;">
      {{nowTime}}
    </text>
    <marquee if="{{chapterListMarqueeEnabled}}" text-offset="25" scrollamount="12" style="position: absolute;left: 130px;top: 46px;width: 172px;line-height: 42px;font-weight:bold;font-size:32px;color:white;text-align:center;">
      {{bookTitle}}
    </marquee>
    <text else style="position: absolute;left: 130px;top: 46px;width: 172px;line-height: 42px;font-weight:bold;font-size:32px;color:white;text-align:center;lines: 1;">
      {{bookTitle}}
    </text>
  </div>
</template>

<script>
import router from '@system.router';
import file from '@system.file';
import prompt from '@system.prompt';
import bookStorage from '../../common/bookStorage.js';
import chapterManager from '../../common/chapterManager.js';
import storage from '../../common/storage.js';

const PAGE_SIZE = 8;

export default {
  private: {
    visibleChapters: [],
    currentPage: 0,
    totalPages: 1,
    totalChapters: 0,
    currentChapterIndex: -1,
    nowTime: "00:00",
    timer: null,
    bookTitle: "",
    loading: false,
    timeFormat: '24h',
    chapterListMarqueeEnabled: false
  },
  protected: {
    name: ''
  },
  updateTime() {
    const date = new Date();
    let hours = date.getHours();
    let minutes = date.getMinutes();
    if (this.timeFormat === '12h') {
        let ampm = hours >= 12 ? '下午' : '上午';
        hours = hours % 12;
        hours = hours ? hours : 12; 
        minutes = minutes < 10 ? '0' + minutes : minutes;
        this.nowTime = `${ampm} ${hours}:${minutes}`;
    } else {
        hours = hours < 10 ? '0' + hours : hours;
        minutes = minutes < 10 ? '0' + minutes : minutes;
        this.nowTime = `${hours}:${minutes}`;
    }
  },
  onInit() {
    storage.get({
        key: 'EBOOK_TIME_FORMAT',
        success: (data) => {
            if (data) {
                this.timeFormat = data;
            }
            this.updateTime();
        },
        fail: () => {
            this.updateTime();
        }
    });
    storage.get({
        key: 'EBOOK_CHAPTER_LIST_MARQUEE_ENABLED',
        success: (data) => {
            this.chapterListMarqueeEnabled = data === 'true';
        },
        fail: () => {
            this.chapterListMarqueeEnabled = false;
        }
    });
    this.timer = setInterval(() => { this.updateTime(); }, 1000);
    this.loadBookInfo();
    this.initChapterList();
  },
  onShow() {
    storage.get({
        key: 'EBOOK_CHAPTER_LIST_MARQUEE_ENABLED',
        success: (data) => {
            this.chapterListMarqueeEnabled = data === 'true';
        },
        fail: () => {
            this.chapterListMarqueeEnabled = false;
        }
    });
  },
  onDestroy() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
    
    this.visibleChapters = null;

    if (typeof global !== 'undefined' && typeof global.runGC === 'function') {
      global.runGC();
    }
  },
  loadBookInfo() {
    const that = this;
    const bookInfoUri = `internal://files/books/${this.name}/book_info.json`;
    file.readText({
      uri: bookInfoUri,
      success: function(data) {
        try {
          const bookInfo = JSON.parse(data.text);
          that.bookTitle = bookInfo.name;
        } catch (e) {
          that.bookTitle = that.name;
        }
      },
      fail: function() {
        that.bookTitle = that.name;
      }
    });
  },
  async initChapterList() {
    if (this.loading) return;
    this.loading = true;

    try {
      const [progress, totalChapters] = await Promise.all([
        bookStorage.get(this.name),
        chapterManager.getTotalChapters(this.name)
      ]);
      
      const chapterIndex = (progress && progress.chapterIndex !== null) ? progress.chapterIndex : -1;

      this.totalChapters = totalChapters || 0;
      this.totalPages = Math.ceil(this.totalChapters / PAGE_SIZE) || 1;
      this.currentChapterIndex = chapterIndex;

      let targetPage = 0;
      if (chapterIndex >= 0 && chapterIndex < this.totalChapters) {
          targetPage = Math.floor(chapterIndex / PAGE_SIZE);
      }
      
      const pageData = await chapterManager.getChapterPage(this.name, targetPage, PAGE_SIZE);
      
      this.visibleChapters = pageData.chapters;
      this.currentPage = pageData.currentPage;

    } catch (error) {
      prompt.showToast({ message: `章节列表加载失败` });
      this.visibleChapters = [];
      this.totalChapters = 0;
      this.totalPages = 1;
      this.currentPage = 0;
      this.currentChapterIndex = -1;
    } finally {
      this.loading = false;
    }
  },
  async loadPage(page) {
    if (this.loading) return;
    this.loading = true;
    
    try {
      const result = await chapterManager.getChapterPage(this.name, page, PAGE_SIZE);
      this.visibleChapters = result.chapters;
      this.currentPage = result.currentPage;
      this.totalPages = result.totalPages;
      this.totalChapters = result.totalChapters;
    } catch (error) {
      prompt.showToast({ message: '加载失败' });
    } finally {
      this.loading = false;
    }
  },
  prevPage() {
    if (this.currentPage > 0 && !this.loading) {
        this.loadPage(this.currentPage - 1);
    }
  },
  nextPage() {
    if (this.currentPage < this.totalPages - 1 && !this.loading) {
        this.loadPage(this.currentPage + 1);
    }
  },
  async selectChapter(chapter) {
    try {
      
      let progress = await bookStorage.get(this.name);
      progress.chapterIndex = chapter.index;
      progress.offsetInChapter = 0;
      progress.scrollOffset = 0;
      await bookStorage.set(this.name, progress);
      progress = null;
      
      globalThis.justJumpedFromChapter = true;
      globalThis.newChapterIndex = chapter.index;
      globalThis.newChapterName = chapter.name;
      router.back();
    } catch (e) {
      prompt.showToast({ message: '跳转失败', duration: 2000 });
    }
  },
  back() {
    router.back();
  }
}
</script>

<style>
.page {
    width: 432px;
    height: 514px;
    background-color: #000000;
}
.list {
    width: 432px;
    height: 514px;
    position: absolute;
    top: 0px;
    left: 0px;
    padding: 116px 12px;
}
.item {
    width: 100%;
    height: 180px;
    padding: 16px 20px;
    margin-bottom: 8px;
    background-color: #262626;
    border-radius: 36px;
    align-items: center;
}
.chapter-info {
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  flex: 1;
  width: 100%;
}
.itemtext {
    font-size: 32px;
    line-height: 42px;
    width: 100%;
    font-weight: bold;
    color: white;
    text-overflow: ellipsis;
    lines: 3;
    margin-bottom: 6px;
}
.itemtext-current {
  color: #0D6EFF;
}
.itemtext2 {
    font-size: 24px;
    line-height: 30px;
    font-weight: bold;
    color: rgba(255,255,255,0.6);
    text-overflow: ellipsis;
    lines: 1;
}
.pagination-container {
    width: 100%;
    height: 80px;
    justify-content: center;
    align-items: center;
}
.pagination-controls {
    width: 100%;
    flex-direction: row;
    align-items: center;
    justify-content: space-around;
    padding: 0 8px;
}
.pagination-button {
    width: 72px;
    height: 72px;
}
.pagination-text {
    font-size: 28px;
    font-weight: bold;
    color: white;
}
</style>
