<template>
  <div class="page">
    <img static src="/common/images/hd.png" style="position:absolute;left:0;top:0;width:192px;height:102px" />
    
    <text style="position: absolute;left: 44px;top: 12px;width: 172px;line-height: 32px;font-weight:bold;font-size:24px;color:rgba(255,255,255,0.6);text-align:center;">
		{{nowTime}}
	  </text>
	  <text static style="position: absolute;left: 44px;top: 40px;width: 172px;line-height: 42px;font-weight:bold;font-size:32px;color:white;text-align:center;">
		  历史记录
	  </text>
    <scroll scroll-y="{{true}}" bounces="{{true}}" style="position:absolute;left:0;top:102px;width:192px;height:412px;">
      <div style="width:192px;padding:0 12px;flex-direction:column;">
        <div class="toolbar">
          <div class="btn" @click="clearHistory"><text class="btn-text">清空</text></div>
        </div>
        <div class="history-list">
          <div for="{{item in history}}" class="item">
            <text class="expr">{{item.expr}}</text>
            <text class="res">= {{item.res}}</text>
          </div>
        </div>
        <div if="{{history.length === 0}}" style="width:100%;align-items:center;justify-content:center;height:200px;">
          <text style="color:rgba(255,255,255,0.6);font-size:22px">暂无历史</text>
        </div>
      </div>
    </scroll>
  </div>
</template>

<script>
import router from '@system.router'
import storage from '../../common/storage.js'
import { KEYS } from '../../common/keys.js'

export default {
  private: {
    nowTime: '00:00',
    timer: null,
    timeFormat: '24h',
    history: []
  },
  updateTime() {
    const date = new Date()
    let hours = date.getHours()
    let minutes = date.getMinutes()
    if (this.timeFormat === '12h') {
      const ampm = hours >= 12 ? '下午' : '上午'
      hours = hours % 12
      hours = hours ? hours : 12
      minutes = minutes < 10 ? '0' + minutes : minutes
      this.nowTime = `${ampm} ${hours}:${minutes}`
    } else {
      hours = hours < 10 ? '0' + hours : hours
      minutes = minutes < 10 ? '0' + minutes : minutes
      this.nowTime = `${hours}:${minutes}`
    }
  },
  onInit() {
    this.updateTime()
    this.timer = setInterval(() => this.updateTime(), 1000)
  },
  onDestroy() {
    if (this.timer) { clearInterval(this.timer); this.timer = null }
  },
  onShow() {
    storage.get({
      key: KEYS.CALC_HISTORY,
      success: (data) => {
        let list = []
        if (Array.isArray(data)) list = data
        else if (typeof data === 'string' && data) {
          try { list = JSON.parse(data) } catch(e) { list = [] }
        }
        this.history = list || []
      }
    })
  },
  clearHistory() {
    this.history = []
    storage.set({ key: KEYS.CALC_HISTORY, value: [] })
  },
  back() { try { this.onVibrate && this.onVibrate() } catch(e) {} ; router.back() },
  onBackPress() { this.back(); return true }
}
</script>

<style>
.page { width: 192px; height: 490px; background-color: #000000; }
.title { position:absolute; left:0; top:16px; width:192px; line-height:32px; font-size:24px; color:white; text-align:center; }
.toolbar { width:100%; height:56px; align-items:center; justify-content:flex-end; }
.btn { width:96px; height:40px; border-radius:20px; background-color:#262626; align-items:center; justify-content:center; }
.btn-text { color:white; font-size:20px; }
.history-list { width:100%; }
.item { width:100%; padding:12px 16px; margin-bottom:8px; background-color:#262626; border-radius:24px; }
.expr { color:white; font-size:22px; }
.res { color:rgba(255,255,255,0.8); font-size:22px; margin-top:4px; }
</style>